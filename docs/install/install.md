## Prerequisites

You need the following devices.

- **Training server**
    - Ubuntu Linux 16.04 (x86_64)
    - NVIDIA GPU with Architecture >= 3.0 (Kepler)
    - NVIDIA drivers >= 410.48
    - Docker >=1.12 (or >=17.03.0)
    - nvidia-docker >= 2.0

    <br>Training by Blueoil is run on docker container with original docker image based on NVIDIA's [CUDA images](https://github.com/NVIDIA/nvidia-docker/wiki/CUDA#requirements) (cuda:10.0-cudnn7-devel).

    The machine running the CUDA container only requires the NVIDIA driver, the CUDA toolkit doesn't have to be installed.

    Please see the detail in the nvidia-docker's [prerequisites](https://github.com/NVIDIA/nvidia-docker/wiki/Installation-(version-2.0)#prerequisites).


- **Your PC**
    - MicroSD card reader
    - Installed xterm program

    <br>When you create Linux system on microSD card, you need a host system (Your PC).
    Also if you run inference on FPGA and you need to display the inference results, you should connect the host and the FPGA over LAN.


- **FPGA Board**
    <br>We currently support the following
    - [DE10-Nano Kit](https://www.terasic.com.tw/cgi-bin/page/archive.pl?Language=English&No=1046)
 (Ubuntu 16.04, distributed by Terasic)

---

## Install / Uninstall Blueoil
This section describes how to setup an environment to train a neural network and convert to an FPGA-ready format via Blueoil.

### Install (On server)

Note: **Install nvidia-docker before installing Blueoil.**

#### Download Blueoil source code from github

Clone the Blueoil repository with recursive option.

    $ git clone --recursive [this repository]

You should run below to update some submodules if cloned without recursive option.

    $ make deps

#### Build the docker image including Blueoil libraries

    $ cd blueoil
    $ make build

After the build has succeeded, you can use the docker image named `blueoil_[User ID]:[TAG based on commit tag]`

### Uninstall (On server)

Remove docker image, container and the `blueoil` directory.

---

## Setup an FPGA Board
This section describes how to setup an environment to run the library generated by Blueoil on a DE10-Nano (SoC FPGA) board.
You need a PC which has a microSD card reader.
All example commands should work if you use Linux or macOS. If you are using a different system, the necessary commands may be different.

### Download Linux system image (On your PC)
You can download an upt-to-date-for-Blueoil Linux system image by:

    $ wget https://leapmind-public-storage.s3-ap-northeast-1.amazonaws.com/os_images/de10nano_ubuntu_TCAv2.img.gz

Downloaded file should contain "de10nano_ubuntu.img".
Insert an empty microSD card (8GB+) into your PC and write the downloaded image to it:

    $ cat de10nano_ubuntu.img.gz | gunzip | sudo dd of=/dev/mmcblk0 bs=4M

Caution:
- On Linux
    - Make sure unmount the microSD with `umount` command before writing.
    - `/dev/xxx` might have a different name, so please confirm the name for the target microSD.
- In macOS
    - Make sure unmount the microSD with `diskutil` command before writing.
    - `/dev/xxx` might have a different name, so please confirm the name for the target microSD.
    - `bs` option of `dd` command should be set to `4m`.

Remove the microSD from your host system after `dd` && `sync` operations have finished.

You can also create a Linux system using an image from Terasic's official website.
Please refer to ['Create Linux system on microSD card'](#create-linux-system-on-microsd-card).

### Connect to the FPGA board (On your PC)

Connect the board to your host system using a mini-b USB cable.
Login to the board via serial.

```
$ sudo cu -l  /dev/ttyUSB0  -s 115200

Connected.

Ubuntu 16.04.1 LTS DE10_NANO ttyS0
```

You can login using the following information:
- User name: root
- Password: (nothing)

When the board is booted with the above image, around 300 MB will be available.
But if one wants to expand the root partition to fill the whole free space available they can do this by running the following commands:

    root@DE10_NANO:~# cd ~
    root@DE10_NANO:~# ./expand_rootfs.sh
    root@DE10_NANO:~# partprobe /dev/mmcblk0
    root@DE10_NANO:~# ./resize2fs_once

---

## [OPTIONAL] Create your own Linux image on microSD card

**NOTE:** if you have already used the provided OS image per ['Setup an FPGA Board'](#setup-an-fpga-board), there is no need to go through this section. This is only for someone who wants to build from the original OS image.

### Download Terasic's official system image (On your PC)
The original image is available from Terasic's official web site.

1. Go to [Terasic's official web site](https://www.terasic.com.tw/en/)
2. Select "Products"
3. Select "DE10-Nano Kit"
4. Select "Resources"
5. Select "Linux BSP (Board Support Package): MicroSD Card Image"
6. Select "Linux LXDE Desktop (kernel 4.5)"

Note: User registration is required to download the image.

Downloaded file contains "DE10_Nano_LXDE.img".
Please insert an empty microSD card into your system and write the downloaded image to it.

    $ sudo dd if=DE10_Nano_LXDE.img of=/dev/mmcblk0 bs=4M && sync

Please remove the microSD from your host system after `dd` && `sync` operation has been finished. And please set the microSD again for further operations.

### Update some files for Blueoil (On your PC)

We need to update some files on the microSD.
To update them, we need to perform a few copy operations.

REQUIRED_FILES are shown below. These files are necessary for a later step.

```
{Blueoil directory}/dlk/hw/intel/de10_nano/
 ├── linux_kernel/zImage
 ├── linux_kernel/kernel_modules.tar.gz
 └── dma/terasic_ubuntu_arm32/udmabuf.ko

{Blueoil directory}/output_files/fpga/
 ├── preloader-mkpimage.bin
 ├── soc_system.rbf
 └── soc_system.dtb
```

Create and copy the required files to the `REQUIRED_FILES` directory.

    $ cd {Blueoil directory}/hw/intel/de10_nano/
    $ cp linux_kernel/zImage linux_kernel/kernel_modules.tar.gz dma/terasic_ubuntu_arm32/udmabuf.ko REQUIRED_FILES/
    $ cd {Blueoil directory}/output_files/fpga/
    $ cp soc_system.dtb soc_system.rbf preloader-mkpimage.bin REQUIRED_FILES/

Note: u-boot.scr does not need updating.

And the actual copy operations should be executed as below. It's assumed that all required files are put in the `REQUIRED_FILES` directory.

    $ cd REQUIRED_FILES
    $ mkdir /media
    $ mount -t vfat /dev/mmcblk0p1 /media
    $ cp zImage /media
    $ cp kernel_modules.tar.gz /media
    $ cp soc_system.dtb /media
    $ cp soc_system.rbf /media
    $ dd if=preloader-mkpimage.bin of=/dev/mmcblk0p3 && sync
    $ cp udmabuf.ko /media

Caution:
- `/dev/xxx` might have different name, so one should confirm the device name of target microSD

### Load a kernel module automatically (On FPGA board)

This section is to make linux load udmabuf.ko automatically during boot.

First, login to the FPGA board, delete old kernel modules and replace them with new ones:

    $ rm -rf /lib/modules/*
    $ mount -t vfat /dev/mmcblk0p1 /media
    $ tar xvzf /media/kernel_modules.tar.gz -C /lib/modules

Second, we need to put udmabuf.ko into the correct directory.

    $ cp /media/udmabuf.ko /lib/modules/4.5.0/kernel/drivers/misc/

Third, update kernel modules with:

    $ echo "udmabuf" >> /etc/modules
    $ depmod
    $ reboot

---

## Install required packages

Login to the FPGA board and update required packages.

    $ apt-get update
    $ apt-get install python-dev python-setuptools python-pip unzip

---

## Other Information

- Initially, networking on the FPGA board is set-up for use with DHCP.
